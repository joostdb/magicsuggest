!function(e){"use strict";var t=function(t,i){var n=this,a={allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(e){return"Please reduce your entry by "+e+" character"+(e>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(e){return"You cannot choose more than "+e+" item"+(e>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(e){return"Please type "+e+" more character"+(e>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useSpaceKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},s=e.extend({},i),r=e.extend(!0,{},a,s);this.addToSelection=function(t,i){if(!r.maxSelection||l.length<r.maxSelection){e.isArray(t)||(t=[t]);var a=!1;e.each(t,function(t,i){(r.allowDuplicates||-1===e.inArray(i[r.valueField],n.getValue()))&&(l.push(i),a=!0)}),a===!0&&(p._renderSelection(),this.empty(),i!==!0&&e(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder","inner"===r.selectionPosition&&this.getValue().length>0?"":r.placeholder)},this.clear=function(e){this.removeFromSelection(l.slice(0),e)},this.collapse=function(){r.expanded===!0&&(this.combobox.detach(),r.expanded=!1,e(this).trigger("collapse",[this]))},this.disable=function(){this.container.addClass("ms-ctn-disabled"),r.disabled=!0,n.input.attr("disabled",!0)},this.empty=function(){this.input.val("")},this.enable=function(){this.container.removeClass("ms-ctn-disabled"),r.disabled=!1,n.input.attr("disabled",!1)},this.expand=function(){!r.expanded&&(this.input.val().length>=r.minChars||this.combobox.children().size()>0)&&(this.combobox.appendTo(this.container),p._processSuggestions(),r.expanded=!0,e(this).trigger("expand",[this]))},this.isDisabled=function(){return r.disabled},this.isValid=function(){var t=r.required===!1||l.length>0;return(r.vtype||r.vregex)&&e.each(l,function(e,i){t=t&&p._validateSingleItem(i[r.valueField])}),t},this.getDataUrlParams=function(){return r.dataUrlParams},this.getName=function(){return r.name},this.getSelection=function(){return l},this.getRawValue=function(){return n.input.val()},this.getValue=function(){return e.map(l,function(e){return e[r.valueField]})},this.removeFromSelection=function(t,i){e.isArray(t)||(t=[t]);var a=!1;e.each(t,function(t,i){var s=e.inArray(i[r.valueField],n.getValue());s>-1&&(l.splice(s,1),a=!0)}),a===!0&&(p._renderSelection(),i!==!0&&e(this).trigger("selectionchange",[this,this.getSelection()]),r.expandOnFocus&&n.expand(),r.expanded&&p._processSuggestions()),this.input.attr("placeholder","inner"===r.selectionPosition&&this.getValue().length>0?"":r.placeholder)},this.getData=function(){return f},this.setData=function(e){r.data=e,p._processSuggestions()},this.setName=function(t){r.name=t,t&&(r.name+=t.indexOf("[]")>0?"":"[]"),n._valueContainer&&e.each(n._valueContainer.children(),function(e,t){t.name=r.name})},this.setSelection=function(e){this.clear(),this.addToSelection(e)},this.setValue=function(t){var i=[];e.each(t,function(t,n){var a=!1;if(e.each(f,function(e,t){return t[r.valueField]==n?(i.push(t),a=!0,!1):void 0}),!a)if("object"==typeof n)i.push(n);else{var s={};s[r.valueField]=n,s[r.displayField]=n,i.push(s)}}),i.length>0&&this.addToSelection(i)},this.setDataUrlParams=function(t){r.dataUrlParams=e.extend({},t)};var c,l=[],o=0,u=!1,d=null,f=[],m=!1,g={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESC:27,SPACE:32,UPARROW:38,DOWNARROW:40,COMMA:188},p={_displaySuggestions:function(t){n.combobox.show(),n.combobox.empty();var i=0,a=0;if(null===d)p._renderComboItems(t),i=o*t.length;else{for(var s in d)a+=1,e("<div/>",{"class":"ms-res-group",html:s}).appendTo(n.combobox),p._renderComboItems(d[s].items,!0);var l=n.combobox.find(".ms-res-group").outerHeight();if(null!==l){var c=a*l;i=o*t.length+c}else i=o*(t.length+a)}if(i<n.combobox.height()||i<=r.maxDropHeight?n.combobox.height(i):i>=n.combobox.height()&&i>r.maxDropHeight&&n.combobox.height(r.maxDropHeight),1===t.length&&r.autoSelect===!0&&n.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active"),r.selectFirst===!0&&n.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active"),0===t.length&&""!==n.getRawValue()){var u=r.noSuggestionText.replace(/\{\{.*\}\}/,n.input.val());p._updateHelper(u),n.collapse()}r.allowFreeEntries===!1&&(0===t.length?(e(n.input).addClass(r.invalidCls),n.combobox.hide()):e(n.input).removeClass(r.invalidCls))},_getEntriesFromStringArray:function(t){var i=[];return e.each(t,function(t,n){var a={};a[r.displayField]=a[r.valueField]=e.trim(n),i.push(a)}),i},_highlightSuggestion:function(t){var i=n.input.val(),a=["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"];if(e.each(a,function(e,t){i=i.replace(t,"\\"+t)}),0===i.length)return t;var s=r.matchCase===!0?"g":"gi";return t.replace(new RegExp("("+i+")(?!([^<]+)?>)",s),"<em>$1</em>")},_moveSelectedRow:function(e){r.expanded||n.expand();var t,i,a,s;t=n.combobox.find(".ms-res-item:not(.ms-res-item-disabled)"),i="down"===e?t.eq(0):t.filter(":last"),a=n.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),a.length>0&&("down"===e?(i=a.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first(),0===i.length&&(i=t.eq(0)),s=n.combobox.scrollTop(),n.combobox.scrollTop(0),i[0].offsetTop+i.outerHeight()>n.combobox.height()&&n.combobox.scrollTop(s+o)):(i=a.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first(),0===i.length&&(i=t.filter(":last"),n.combobox.scrollTop(o*t.length)),i[0].offsetTop<n.combobox.scrollTop()&&n.combobox.scrollTop(n.combobox.scrollTop()-o))),t.removeClass("ms-res-item-active"),i.addClass("ms-res-item-active")},_processSuggestions:function(t){var i=null,a=t||r.data;if(null!==a){if("function"==typeof a&&(a=a.call(n,n.getRawValue())),"string"==typeof a){e(n).trigger("beforeload",[n]);var s={};s[r.queryParam]=n.input.val();var l=e.extend(s,r.dataUrlParams);return void e.ajax(e.extend({type:r.method,url:a,data:l,beforeSend:r.beforeSend,success:function(t){i="string"==typeof t?JSON.parse(t):t,p._processSuggestions(i),e(n).trigger("load",[n,i]),p._asyncValues&&(n.setValue("string"==typeof p._asyncValues?JSON.parse(p._asyncValues):p._asyncValues),p._renderSelection(),delete p._asyncValues)},error:function(){throw"Could not reach server"}},r.ajaxConfig))}f=a.length>0&&"string"==typeof a[0]?p._getEntriesFromStringArray(a):a[r.resultsField]||a;var o="remote"===r.mode?f:p._sortAndTrim(f);p._displaySuggestions(p._group(o))}},_render:function(t){if(n.setName(r.name),n.container=e("<div/>",{"class":"ms-ctn form-control "+(r.resultAsString?"ms-as-string ":"")+r.cls+(e(t).hasClass("input-lg")?" input-lg":"")+(e(t).hasClass("input-sm")?" input-sm":"")+(r.disabled===!0?" ms-ctn-disabled":"")+(r.editable===!0?"":" ms-ctn-readonly")+(r.hideTrigger===!1?"":" ms-no-trigger"),style:r.style,id:r.id}),n.container.focus(e.proxy(h._onFocus,this)),n.container.blur(e.proxy(h._onBlur,this)),n.container.keydown(e.proxy(h._onKeyDown,this)),n.container.keyup(e.proxy(h._onKeyUp,this)),n.input=e("<input/>",e.extend({type:"text","class":r.editable===!0?"":" ms-input-readonly",readonly:!r.editable,placeholder:r.placeholder,disabled:r.disabled},r.inputCfg)),n.input.focus(e.proxy(h._onInputFocus,this)),n.input.click(e.proxy(h._onInputClick,this)),n.combobox=e("<div/>",{"class":"ms-res-ctn dropdown-menu"}).height(r.maxDropHeight),n.combobox.on("click","div.ms-res-item",e.proxy(h._onComboItemSelected,this)),n.combobox.on("mouseover","div.ms-res-item",e.proxy(h._onComboItemMouseOver,this)),r.selectionContainer?(n.selectionContainer=r.selectionContainer,e(n.selectionContainer).addClass("ms-sel-ctn")):n.selectionContainer=e("<div/>",{"class":"ms-sel-ctn"}),n.selectionContainer.click(e.proxy(h._onFocus,this)),"inner"!==r.selectionPosition||r.selectionContainer?n.container.append(n.input):n.selectionContainer.append(n.input),n.helper=e("<span/>",{"class":"ms-helper "+r.infoMsgCls}),p._updateHelper(),n.container.append(n.helper),e(t).replaceWith(n.container),!r.selectionContainer)switch(r.selectionPosition){case"bottom":n.selectionContainer.insertAfter(n.container),r.selectionStacked===!0&&(n.selectionContainer.width(n.container.width()),n.selectionContainer.addClass("ms-stacked"));break;case"right":n.selectionContainer.insertAfter(n.container),n.container.css("float","left");break;default:n.container.append(n.selectionContainer)}r.hideTrigger===!1&&(n.trigger=e("<div/>",{"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),n.trigger.click(e.proxy(h._onTriggerClick,this)),n.container.append(n.trigger)),e(window).resize(e.proxy(h._onWindowResized,this)),(null!==r.value||null!==r.data)&&("string"==typeof r.data?(p._asyncValues=r.value,p._processSuggestions()):(p._processSuggestions(),null!==r.value&&(n.setValue(r.value),p._renderSelection()))),e("body").click(function(e){n.container.hasClass("ms-ctn-focus")&&0===n.container.has(e.target).length&&e.target.className.indexOf("ms-res-item")<0&&e.target.className.indexOf("ms-close-btn")<0&&n.container[0]!==e.target&&h._onBlur()}),r.expanded===!0&&(r.expanded=!1,n.expand())},_renderComboItems:function(t,i){var a=this,s="";e.each(t,function(t,n){var l=null!==r.renderer?r.renderer.call(a,n):n[r.displayField],o=null!==r.disabledField&&n[r.disabledField]===!0,c=e("<div/>",{"class":"ms-res-item "+(i?"ms-res-item-grouped ":"")+(o?"ms-res-item-disabled ":"")+(t%2===1&&r.useZebraStyle===!0?"ms-res-odd":""),html:r.highlight===!0?p._highlightSuggestion(l):l,"data-json":JSON.stringify(n)});s+=e("<div/>").append(c).html()}),n.combobox.append(s),o=n.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var t=this,i=0,a=0,s=[],o=r.resultAsString===!0&&!u;n.selectionContainer.find(".ms-sel-item").remove(),void 0!==n._valueContainer&&n._valueContainer.remove(),e.each(l,function(i,n){var a,c,u=null!==r.selectionRenderer?r.selectionRenderer.call(t,n):n[r.displayField],d=p._validateSingleItem(n[r.displayField])?"":" ms-sel-invalid";o===!0?a=e("<div/>",{"class":"ms-sel-item ms-sel-text "+r.selectionCls+d,html:u+(i===l.length-1?"":r.resultAsStringDelimiter)}).data("json",n):(a=e("<div/>",{"class":"ms-sel-item "+r.selectionCls+d,html:u}).data("json",n),r.disabled===!1&&(c=e("<span/>",{"class":"ms-close-btn"}).data("json",n).appendTo(a),c.click(e.proxy(h._onTagTriggerClick,t)))),s.push(a)}),n.selectionContainer.prepend(s),n._valueContainer=e("<div/>",{style:"display: none;"}),e.each(n.getValue(),function(t,i){var a=e("<input/>",{type:"hidden",name:r.name,value:i});a.appendTo(n._valueContainer)}),n._valueContainer.appendTo(n.selectionContainer),"inner"!==r.selectionPosition||r.selectionContainer||(n.input.width(0),a=n.input.offset().left-n.selectionContainer.offset().left,i=n.container.width()-a-42,n.input.width(i)),l.length===r.maxSelection?p._updateHelper(r.maxSelectionRenderer.call(this,l.length)):n.helper.hide()},_selectItem:function(e){1===r.maxSelection&&(l=[]),n.addToSelection(e.data("json")),e.removeClass("ms-res-item-active"),(r.expandOnFocus===!1||l.length===r.maxSelection)&&n.collapse(),u?u&&(r.expandOnFocus||m)&&(p._processSuggestions(),m&&n.expand()):n.input.focus()},_sortAndTrim:function(t){var i=n.getRawValue(),a=[],s=[],l=n.getValue();return i.length>0?e.each(t,function(e,t){var n=t[r.displayField];(r.matchCase===!0&&n.indexOf(i)>-1||r.matchCase===!1&&n.toLowerCase().indexOf(i.toLowerCase())>-1)&&(r.strictSuggest===!1||0===n.toLowerCase().indexOf(i.toLowerCase()))&&a.push(t)}):a=t,e.each(a,function(t,i){(r.allowDuplicates||-1===e.inArray(i[r.valueField],l))&&s.push(i)}),null!==r.sortOrder&&s.sort(function(e,t){return e[r.sortOrder]<t[r.sortOrder]?"asc"===r.sortDir?-1:1:e[r.sortOrder]>t[r.sortOrder]?"asc"===r.sortDir?1:-1:0}),r.maxSuggestions&&r.maxSuggestions>0&&(s=s.slice(0,r.maxSuggestions)),s},_group:function(t){return null!==r.groupBy&&(d={},e.each(t,function(e,t){var i=r.groupBy.indexOf(".")>-1?r.groupBy.split("."):r.groupBy,n=t[r.groupBy];if("string"!=typeof i)for(n=t;i.length>0;)n=n[i.shift()];void 0===d[n]?d[n]={title:n,items:[t]}:d[n].items.push(t)})),t},_updateHelper:function(e){n.helper.html(e),n.helper.is(":visible")||n.helper.fadeIn()},_validateSingleItem:function(e){if(null!==r.vregex&&r.vregex instanceof RegExp)return r.vregex.test(e);if(null!==r.vtype)switch(r.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(e);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(e);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(e);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(e);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(e)}return!0}},h={_onBlur:function(){if(n.container.removeClass("ms-ctn-focus"),n.collapse(),u=!1,""!==n.getRawValue()&&r.allowFreeEntries===!0){var t={};t[r.displayField]=t[r.valueField]=n.getRawValue().trim(),n.addToSelection(t)}p._renderSelection(),n.isValid()===!1?n.container.addClass(r.invalidCls):""!==n.input.val()&&r.allowFreeEntries===!1&&(n.empty(),p._updateHelper("")),e(n).trigger("blur",[n])},_onComboItemMouseOver:function(t){var i=e(t.currentTarget);i.hasClass("ms-res-item-disabled")||(n.combobox.children().removeClass("ms-res-item-active"),i.addClass("ms-res-item-active"))},_onComboItemSelected:function(t){var i=e(t.currentTarget);i.hasClass("ms-res-item-disabled")||p._selectItem(e(t.currentTarget))},_onFocus:function(){n.input.focus()},_onInputClick:function(){n.isDisabled()===!1&&u&&r.toggleOnClick===!0&&(r.expanded?n.collapse():n.expand())},_onInputFocus:function(){if(n.isDisabled()===!1&&!u){u=!0,n.container.addClass("ms-ctn-focus"),n.container.removeClass(r.invalidCls);var t=n.getRawValue().length;r.expandOnFocus===!0&&n.expand(),l.length===r.maxSelection?p._updateHelper(r.maxSelectionRenderer.call(this,l.length)):t<r.minChars&&p._updateHelper(r.minCharsRenderer.call(this,r.minChars-t)),p._renderSelection(),e(n).trigger("focus",[n])}},_onKeyDown:function(t){var i=n.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),a=n.input.val();if(e(n).trigger("keydown",[n,t]),t.keyCode===g.TAB&&(r.useTabKey===!1||r.useTabKey===!0&&0===i.length&&0===n.input.val().length))return void h._onBlur();switch(t.keyCode){case g.BACKSPACE:0===a.length&&n.getSelection().length>0&&"inner"===r.selectionPosition&&(l.pop(),p._renderSelection(),e(n).trigger("selectionchange",[n,n.getSelection()]),n.input.attr("placeholder","inner"===r.selectionPosition&&n.getValue().length>0?"":r.placeholder),n.input.focus(),t.preventDefault());break;case g.TAB:case g.ESC:t.preventDefault();break;case g.ENTER:(""!==a||r.expanded)&&t.preventDefault();break;case g.COMMA:r.useCommaKey===!0&&t.preventDefault();break;case g.SPACE:r.useSpaceKey===!0&&t.preventDefault();break;case g.CTRL:m=!0;break;case g.DOWNARROW:t.preventDefault(),p._moveSelectedRow("down");break;case g.UPARROW:t.preventDefault(),p._moveSelectedRow("up");break;default:l.length===r.maxSelection&&t.preventDefault()}},_onKeyUp:function(t){var s,i=n.getRawValue(),a=e.trim(n.input.val()).length>0&&(!r.maxEntryLength||e.trim(n.input.val()).length<=r.maxEntryLength),o={};if(e(n).trigger("keyup",[n,t]),clearTimeout(c),t.keyCode===g.ESC&&r.expanded&&n.combobox.hide(),t.keyCode===g.TAB&&r.useTabKey===!1||t.keyCode>g.ENTER&&t.keyCode<g.SPACE)return void(t.keyCode===g.CTRL&&(m=!1));switch(t.keyCode){case g.UPARROW:case g.DOWNARROW:t.preventDefault();break;case g.ENTER:case g.TAB:case g.COMMA:case g.SPACE:if(t.keyCode!==g.COMMA||r.useCommaKey===!0){if(t.preventDefault(),r.expanded===!0&&(s=n.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),s.length>0))return void p._selectItem(s);a===!0&&r.allowFreeEntries===!0&&(o[r.displayField]=o[r.valueField]=i.trim(),n.addToSelection(o),n.collapse(),n.input.focus());break}default:l.length===r.maxSelection?p._updateHelper(r.maxSelectionRenderer.call(this,l.length)):i.length<r.minChars?(p._updateHelper(r.minCharsRenderer.call(this,r.minChars-i.length)),r.expanded===!0&&n.collapse()):r.maxEntryLength&&i.length>r.maxEntryLength?(p._updateHelper(r.maxEntryRenderer.call(this,i.length-r.maxEntryLength)),r.expanded===!0&&n.collapse()):(n.helper.hide(),r.minChars<=i.length&&(c=setTimeout(function(){r.expanded===!0?p._processSuggestions():n.expand()},r.typeDelay)))}},_onTagTriggerClick:function(t){n.removeFromSelection(e(t.currentTarget).data("json"))},_onTriggerClick:function(){if(n.isDisabled()===!1&&(r.expandOnFocus!==!0||l.length!==r.maxSelection))if(e(n).trigger("triggerclick",[n]),r.expanded===!0)n.collapse();else{var t=n.getRawValue().length;t>=r.minChars?(n.input.focus(),n.expand()):p._updateHelper(r.minCharsRenderer.call(this,r.minChars-t))}},_onWindowResized:function(){p._renderSelection()}};null!==t&&p._render(t)};e.fn.magicSuggest=function(i){var n=e(this);return 1===n.size()&&n.data("magicSuggest")?n.data("magicSuggest"):(n.each(function(){var a=e(this);if(!a.data("magicSuggest")){"select"===this.nodeName.toLowerCase()&&(i.data=[],i.value=[],e.each(this.children,function(t,n){n.nodeName&&"option"===n.nodeName.toLowerCase()&&(i.data.push({id:n.value,name:n.text}),e(n).attr("selected")&&i.value.push(n.value))}));var s={};e.each(this.attributes,function(e,t){s[t.name]="value"===t.name&&""!==t.value?JSON.parse(t.value):t.value});var r=new t(this,e.extend([],e.fn.magicSuggest.defaults,i,s));a.data("magicSuggest",r),r.container.data("magicSuggest",r)}}),1===n.size()?n.data("magicSuggest"):n)},e.fn.magicSuggest.defaults={}}(jQuery);
